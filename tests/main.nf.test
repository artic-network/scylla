nextflow_pipeline {

    name "End to end pipeline test, single-end long-read"
    script "main.nf"
    tag "e2e"

    test("e2e-lr") {

        when {
            params {
                fastq = "${projectDir}/tests/test-data/barcode01/barcode01.fq.gz"
                outdir = "$outputDir/single_long_read"
                raise_server = true
                kraken_database                  = [
                    "default": [
                        "name": "PlusPF",
                        "path":"${projectDir}/tests/test-data/database/testdb-kraken2",
                        "host": "127.0.0.1",
                        "port": 8080,
                    ],
                ]
            }
        }

        then {
            // check basic has pipeline completed
            assert workflow.success
            assert path("$params.outdir/barcode01").exists()

            // check pre-process outputs
            assert path("$params.outdir/barcode01/preprocess").exists()
            assert path("$params.outdir/barcode01/preprocess/barcode01.fastp.fastq.gz").exists()
            assert path("$params.outdir/barcode01/preprocess/barcode01.fastp.json").exists()
            
            // check kraken outputs
            assert path("$params.outdir/barcode01/classifications").exists()
            assert path("$params.outdir/barcode01/classifications/PlusPF.kraken_assignments.tsv").exists()
            assert path("$params.outdir/barcode01/classifications/PlusPF.kraken_report.txt").exists()

            // check qc outputs
            assert path("$params.outdir/barcode01/qc").exists()
            assert path("$params.outdir/barcode01/qc/hcid.counts.csv").exists()
            assert path("$params.outdir/barcode01/qc/raw_reads.stats").exists()
            assert path("$params.outdir/barcode01/qc/total_length.json").exists()

            assert path("$params.outdir/barcode01/read_fractions").exists()
            assert path("$params.outdir/barcode01/reads_by_taxa").exists()
            assert path("$params.outdir/barcode01/barcode01_report.html").exists()
        }

    }

}
